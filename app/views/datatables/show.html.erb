<% cache(:action_suffix => 'page') do %>
  <h1><%=raw datatable.title %></h1>

  <p class='description'>
    <%=raw textilize datatable.description.presence %>
  </p>
  <%= datatable.summary_graph %>
  <%= datatable.access_statement %>

  <!-- TODO Temporary: use the default if sponsor is lter. -->
  <% if datatable.sponsor_name == 'lter' %>
    The <a href='http://lter.kbs.msu.edu/data/terms_of_use.php'>standard data use policy applies to the this dataset</a>
  <% else %>
    The <%=link_to 'standard data use policy applies to the this dataset' , termsofuse_path(datatable.dataset.sponsor)%>
  <% end %>


  <div>
    <h2>Context:</h2>
    <div class='truncate'>
      <%=raw textilize datatable.dataset.try(:abstract) %>
    </div>
  </div>

  <table class='data-description'>
    <% if datatable.study %>
      <tr>
        <td>Experiment:</td>
        <td>
          <%= link_to_if datatable.study_link_for(@website),
              datatable.study_name, datatable.study_link_for(@website) %>
        </td>
      </tr>
    <% end %>
    <% if datatable.begin_date && datatable.end_date %>
      <tr>
        <td>Temporal Coverage:</td>
        <td><%= datatable.begin_date %> to <%= datatable.end_date %></td>
      </tr>
    <% end %>
    <tr>
      <td>Dataset:</td>
      <td><%= link_to datatable.dataset, dataset_url(datatable.dataset) %></td>
    </tr>
    <tr>
      <td>Datatable ID:</td>
      <td><%= datatable.name %></td>
    </tr>
    <% if datatable.related_tables.any? %>
      <tr>
        <td>Related Tables:</td>
        <td><ul>
          <% datatable.related_tables.each do |table| %>
            <li><%=link_to raw(table.title) , datatable_path(table) %></li>
          <% end %>
        </ul></td>
      </tr>
    <% end -%>
    <tr>
      <td>Personnel:</td>
      <td>
        <ul>
          <% personnel = datatable.personnel -%>
          <% personnel.keys.each do |key| -%>
            <li>
              <%= link_to "#{key.full_name}", person_path(key.id)%>, <%= personnel[key].join(',') %>
            </li>
          <% end %>
        </ul>
      </td>
    </tr>
    <tr>
      <td>Last Updated</td>
      <td><%= distance_of_time_in_words_to_now @datatable.updated_at%> ago (on <%= @datatable.updated_at.strftime("%Y-%m-%d")%>)</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>
        <ul>
          <li><%= link_to 'Complete EML', dataset_path(datatable.dataset, :format => :eml) %></li>
        </ul>
      </td>
    </tr>
  </table>

  <table class='variate-table'>
    <tr>
      <th>Variate</th>
      <th>Description</th>
      <th>Units</th>
    </tr>
    <% datatable.variates.each do |variate| -%>
      <tr>
        <td class='space-after'>
          <%= variate.name.gsub(/_/,' ') %>
        </td>
        <td class='space-after'>
          <%= variate.description %>
        </td>
        <td>
          <%= variate.unit.human_name if variate.unit %>
        </td>
      </tr>
    <% end -%>
  </table>

<% end %> 

<% if datatable.is_sql %>
  <% if datatable.dataset.sponsor.name == 'glbrc' %>
    <p class='highlight'>GLBRC data is not yet publicly available.</p>
  <% end %>
  <% if datatable.values -%>
      <!--
    	TODO: geographic coverage
    	-->
    <%= render 'protocols', :datatable => datatable %>
    <%= render 'download_button', :datatable => datatable, :website => @website %>
    <%= render 'data_preview',    :datatable => datatable %>
  <% end %>
<% else %>
  <% if datatable.object? %>
    <p>
      <%= link_to 'Data', datatable.data_url %> (on a different page)
    </p>
  <% else %>
    <p>Data Embargoed</p>
  <% end %>
<% end %>

<%= link_to 'Back to Data Catalog', datatables_path() %>&nbsp;&nbsp;
<%= link_to 'Edit', edit_datatable_path(datatable) if admin? %>
